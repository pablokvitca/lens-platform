# Scheduling Preview Flow Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Make scheduling results reversible by renaming `forming` → `preview` status, updating realize-groups to filter by status and set `active`, and keeping signups instead of deleting them.

**Architecture:** Three coordinated changes: (1) rename enum in Python + tables.py then autogenerate Alembic migration, (2) scheduling logic change to keep signups, (3) realize-groups to use status-based filtering and update status to `active`.

**Tech Stack:** PostgreSQL (Alembic migrations), Python (SQLAlchemy Core), discord.py

---

## Task 1: Update All Python References from `forming` to `preview`

Update all Python code that references the `forming` status before generating the migration.

**Files:**
- Modify: `core/enums.py:19-23`
- Modify: `core/tables.py:136`
- Modify: `core/queries/groups.py:33`
- Modify: `core/queries/facilitator.py:52`

**Step 1: Update GroupStatus enum in `core/enums.py`**

Change line 20:
```python
forming = "forming"
```
To:
```python
preview = "preview"
```

**Step 2: Update server_default in `core/tables.py`**

Change line 136:
```python
Column("status", group_status_enum, server_default="forming"),
```
To:
```python
Column("status", group_status_enum, server_default="preview"),
```

**Step 3: Update create_group in `core/queries/groups.py`**

Find the `create_group` function (around line 27-38) and change:
```python
status="forming",
```
To:
```python
status="preview",
```

**Step 4: Update get_accessible_groups in `core/queries/facilitator.py`**

Change line 52:
```python
.where(groups.c.status.in_(["forming", "active", "completed"]))
```
To:
```python
.where(groups.c.status.in_(["preview", "active", "completed"]))
```

**Step 5: Search for any remaining references**

Run:
```bash
rg "forming" --type py
```

Expected: No references except in alembic migration files (which is OK).

**Step 6: Commit**

```bash
jj desc -m "refactor: rename GroupStatus.forming to preview in all Python code"
```

---

## Task 2: Generate and Run Alembic Migration

**Files:**
- Create: `alembic/versions/XXXX_rename_forming_to_preview.py` (auto-generated)

**Step 1: Generate migration**

Run:
```bash
alembic revision --autogenerate -m "rename group_status forming to preview"
```

Expected: Creates new migration file. Review it - it should contain the enum rename and server_default change.

**Step 2: Review and edit migration if needed**

The autogenerated migration may not handle enum value rename correctly. If it doesn't include the enum rename, manually add:

```python
def upgrade() -> None:
    op.execute("ALTER TYPE group_status RENAME VALUE 'forming' TO 'preview'")
    # ... any other autogenerated changes


def downgrade() -> None:
    op.execute("ALTER TYPE group_status RENAME VALUE 'preview' TO 'forming'")
    # ... any other autogenerated changes
```

**Step 3: Run migration**

Run:
```bash
alembic upgrade head
```

Expected: Migration applies successfully.

**Step 4: Commit**

```bash
jj desc -m "chore(db): migrate group_status enum value forming to preview"
```

---

## Task 3: Update Scheduling to Keep Signups

**Files:**
- Modify: `core/scheduling.py`

**Step 1: Remove the signup deletion block**

Find lines 462-474 (the delete block):
```python
# Update signups: delete grouped users, mark ungroupable users
...
if grouped_user_ids:
    # Delete signups for grouped users (they're now in groups_users)
    await conn.execute(
        delete(signups)
        .where(signups.c.cohort_id == cohort_id)
        .where(signups.c.user_id.in_(list(grouped_user_ids)))
    )
```

Delete the entire `if grouped_user_ids:` block (lines 468-474). Keep the comment but update it:
```python
# Mark ungroupable users (signups are kept for all users)
```

**Step 2: Add imports for groups and groups_users tables**

At line 19, change:
```python
from .tables import signups, users, facilitators
```
To:
```python
from .tables import signups, users, facilitators, groups, groups_users
```

**Step 3: Update the scheduler query to exclude already-grouped users**

Find the query at lines 293-309. Before the query, add a subquery:
```python
# Subquery: users already in groups for this cohort
already_grouped = (
    select(groups_users.c.user_id)
    .join(groups, groups_users.c.group_id == groups.c.group_id)
    .where(groups.c.cohort_id == cohort_id)
)
```

Then add `.where(users.c.user_id.notin_(already_grouped))` to the main query's WHERE clauses.

**Step 4: Remove unused import**

Remove `delete` from the sqlalchemy import at line 10 if it's no longer used elsewhere in the file:
```python
from sqlalchemy import select, update  # Remove 'delete' if unused
```

**Step 5: Run tests**

Run:
```bash
pytest core/tests/test_scheduling.py -v
```

Expected: Tests pass.

**Step 6: Commit**

```bash
jj desc -m "fix(scheduling): keep signups after grouping, exclude already-grouped users"
```

---

## Task 4: Update get_realizable_cohorts to Filter by Status

**Files:**
- Modify: `core/queries/cohorts.py:47-64`

**Step 1: Add import for GroupStatus**

After line 10 (the imports section), add:
```python
from ..enums import GroupStatus
```

**Step 2: Update the query**

Change the `unrealized` subquery from:
```python
unrealized = (
    select(groups.c.cohort_id)
    .where(groups.c.discord_text_channel_id.is_(None))
    .distinct()
    .subquery()
)
```

To:
```python
unrealized = (
    select(groups.c.cohort_id)
    .where(groups.c.status == GroupStatus.preview)
    .distinct()
    .subquery()
)
```

**Step 3: Commit**

```bash
jj desc -m "refactor(queries): filter realizable cohorts by status=preview"
```

---

## Task 5: Update realize-groups to Set Status to Active

**Files:**
- Modify: `core/queries/groups.py`

**Step 1: Add import for GroupStatus**

Near the top of the file, add:
```python
from ..enums import GroupStatus
```

**Step 2: Update save_discord_channel_ids**

Find the function (around line 166-181) and add `status=GroupStatus.active` to the values:

```python
async def save_discord_channel_ids(
    conn: AsyncConnection,
    group_id: int,
    text_channel_id: str,
    voice_channel_id: str,
) -> None:
    """Update group with Discord channel IDs and set status to active after realization."""
    await conn.execute(
        update(groups)
        .where(groups.c.group_id == group_id)
        .values(
            discord_text_channel_id=text_channel_id,
            discord_voice_channel_id=voice_channel_id,
            status=GroupStatus.active,
            updated_at=datetime.now(timezone.utc),
        )
    )
```

**Step 3: Commit**

```bash
jj desc -m "feat(groups): set status to active when realizing groups"
```

---

## Task 6: Update groups_cog.py and Query to Use Status

**Files:**
- Modify: `discord_bot/cogs/groups_cog.py:144-147`
- Modify: `core/queries/groups.py` (get_cohort_groups_for_realization function)

**Step 1: Update get_cohort_groups_for_realization to return status**

Find the function in `core/queries/groups.py`. Locate where the group dict is built (around line 140-148) and add `"status"`:

```python
groups_list.append(
    {
        "group_id": group_data["group_id"],
        "group_name": group_data["group_name"],
        "recurring_meeting_time_utc": group_data["recurring_meeting_time_utc"],
        "discord_text_channel_id": group_data["discord_text_channel_id"],
        "discord_voice_channel_id": group_data["discord_voice_channel_id"],
        "status": group_data["status"],
        "members": members,
    }
)
```

Note: The query already uses `select(groups)` which selects all columns including `status`, so no query change needed.

**Step 2: Update the skip condition in groups_cog.py**

Change lines 144-147:
```python
for group_data in cohort_data["groups"]:
    # Skip if already realized
    if group_data["discord_text_channel_id"]:
        continue
```

To:
```python
for group_data in cohort_data["groups"]:
    # Skip if already realized (not in preview status)
    if group_data.get("status") != "preview":
        continue
```

**Step 3: Commit**

```bash
jj desc -m "refactor(realize-groups): filter by status instead of channel ID"
```

---

## Task 7: Update Tests

**Files:**
- Modify: `discord_bot/tests/test_scheduling_queries.py:134`

**Step 1: Update test assertion**

Find line 134:
```python
assert group["status"] == "forming"
```

Change to:
```python
assert group["status"] == "preview"
```

**Step 2: Search for other test references**

Run:
```bash
rg "forming" --type py tests/ discord_bot/tests/ core/tests/
```

Update any other test assertions that reference `"forming"`.

**Step 3: Run all tests**

Run:
```bash
pytest
```

Expected: All tests pass.

**Step 4: Commit**

```bash
jj desc -m "test: update assertions for forming->preview rename"
```

---

## Task 8: Final Verification

**Step 1: Run linting**

Run:
```bash
ruff check .
ruff format --check .
```

Expected: No errors.

**Step 2: Build frontend**

Run:
```bash
cd web_frontend && npm run lint && npm run build
```

Expected: Build succeeds.

**Step 3: Manual verification checklist**

- [ ] Start server: `python main.py --dev`
- [ ] Check database: `SELECT DISTINCT status FROM groups;` should show `preview` not `forming`
- [ ] Run `/schedule` on a test cohort → groups created with `status = 'preview'`
- [ ] Check signups table → signups still exist for grouped users
- [ ] Run `/realize-groups` → status changes to `active`, Discord channels created
- [ ] Delete preview groups: `DELETE FROM groups WHERE cohort_id = X AND status = 'preview';`
- [ ] Re-run `/schedule` → works correctly, creates new groups

---

## Summary of Changes

| File | Change |
|------|--------|
| `core/enums.py` | `GroupStatus.forming` → `GroupStatus.preview` |
| `core/tables.py` | `server_default="forming"` → `server_default="preview"` |
| `core/queries/groups.py` | `status="forming"` → `status="preview"`, add `status=GroupStatus.active` on realize, return status in dict |
| `core/queries/facilitator.py` | Update status list to use `"preview"` |
| `core/queries/cohorts.py` | Filter realizable cohorts by `status = preview` |
| `core/scheduling.py` | Remove signup deletion, add subquery to exclude already-grouped |
| `discord_bot/cogs/groups_cog.py` | Skip groups not in `preview` status |
| `discord_bot/tests/test_scheduling_queries.py` | Update test assertion |
| `alembic/versions/XXXX_*.py` | Migration: rename enum `forming` → `preview` |

## Rollback Instructions

If something goes wrong:
1. Run `alembic downgrade -1` to revert enum rename
2. Revert code changes with `jj restore`
3. Groups already set to `active` will remain (data is safe)
4. If groups were created with `preview` status before rollback, run: `UPDATE groups SET status = 'forming' WHERE status = 'preview';` before downgrading migration
