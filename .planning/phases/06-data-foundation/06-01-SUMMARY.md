---
phase: 06-data-foundation
plan: 01
subsystem: database
tags: [postgresql, sqlalchemy-core, alembic, jsonb, assessment, async]

# Dependency graph
requires: []
provides:
  - assessment_responses table for storing student answers
  - assessment_scores table for storing AI scoring results
  - core/assessments.py CRUD functions (submit_response, get_responses, get_responses_for_question, claim_assessment_responses)
  - Alembic migration ready for user review
affects: [06-02, 07-answer-box-ui, 09-ai-scoring]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "JSONB for flexible assessment score storage (schema flexibility per user decision)"
    - "Dual user_id/anonymous_token pattern extended to assessment responses"
    - "claim pattern for anonymous-to-authenticated transition (same as progress records)"

key-files:
  created:
    - core/assessments.py
    - alembic/versions/0ef080fc2fd5_add_assessment_responses_and_assessment_.py
  modified:
    - core/tables.py
    - core/__init__.py

key-decisions:
  - "JSONB for answer_metadata and score_data columns -- schema flexibility per user decision"
  - "No unique constraint on (user, question) -- multiple attempts supported as separate records"
  - "Separate assessment_scores table decoupled from responses -- scores created async by AI in Phase 9"
  - "claim_assessment_responses skips existing user responses to avoid duplicates (same pattern as progress)"
  - "Removed autogenerated apscheduler_jobs drop from migration -- external table not managed by our schema"

patterns-established:
  - "Assessment CRUD: async functions taking AsyncConnection, returning dicts, using SQLAlchemy Core"
  - "Assessment table sections numbered 13-14 in core/tables.py following existing convention"

# Metrics
duration: 3min
completed: 2026-02-14
---

# Phase 6 Plan 1: Assessment Data Schema Summary

**SQLAlchemy Core tables (assessment_responses + assessment_scores) with JSONB flexibility, Alembic migration, and async CRUD module following existing dual-auth patterns**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-14T12:06:04Z
- **Completed:** 2026-02-14T12:08:54Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments
- Two new database tables added to core/tables.py (sections 13-14) with proper indexes, FKs, and JSONB columns
- Alembic migration generated, reviewed, and cleaned up (removed spurious apscheduler_jobs drop, verified FK dependency order in downgrade)
- core/assessments.py created with 4 async CRUD functions following existing codebase patterns
- All functions exported from core/__init__.py for use by adapters

## Task Commits

Each task was committed atomically:

1. **Task 1: Add assessment tables to core/tables.py and generate Alembic migration** - `02a5ebc` (feat)
2. **Task 2: Create core/assessments.py with CRUD functions and export from core/__init__.py** - `3b76f51` (feat)

## Files Created/Modified
- `core/tables.py` - Added assessment_responses (section 13) and assessment_scores (section 14) table definitions
- `core/assessments.py` - New module with submit_response, get_responses, get_responses_for_question, claim_assessment_responses
- `core/__init__.py` - Added exports for all 4 assessment functions
- `alembic/versions/0ef080fc2fd5_add_assessment_responses_and_assessment_.py` - Migration creating both tables with indexes and FKs

## Decisions Made
- Used JSONB for both answer_metadata and score_data (per user decision for schema flexibility)
- No unique constraint on (user_id, question_id) -- multiple response attempts are separate records
- assessment_scores in a separate table from assessment_responses -- responses are synchronous, scores are async (Phase 9)
- claim_assessment_responses uses same skip-existing pattern as claim_progress_records
- Removed unused assessment_scores import from assessments.py (only needed when Phase 9 adds scoring CRUD)

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Removed unused import flagged by ruff**
- **Found during:** Task 2
- **Issue:** assessment_scores was imported in core/assessments.py but not used (scoring CRUD is Phase 9 scope)
- **Fix:** Removed unused import to pass linting
- **Files modified:** core/assessments.py
- **Verification:** ruff check passes clean
- **Committed in:** 3b76f51 (Task 2 commit)

**2. [Rule 1 - Bug] Removed spurious apscheduler_jobs drop from migration**
- **Found during:** Task 1
- **Issue:** Alembic autogenerate detected apscheduler_jobs (external table) as removed and included drop statements
- **Fix:** Removed apscheduler_jobs drop from upgrade() and create from downgrade()
- **Files modified:** alembic/versions/0ef080fc2fd5_add_assessment_responses_and_assessment_.py
- **Verification:** Migration only contains assessment table operations
- **Committed in:** 02a5ebc (Task 1 commit)

---

**Total deviations:** 2 auto-fixed (2 bugs)
**Impact on plan:** Both fixes necessary for correctness. No scope creep.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required. Migration is ready for user review before running.

## Next Phase Readiness
- Tables and CRUD functions ready for Phase 06-02 (API endpoints and content parsing)
- Migration needs user review and approval before running against database
- claim_assessment_responses ready to be wired into auth flow alongside existing claim functions

## Self-Check: PASSED

All 4 created/modified files verified on disk. Both task commits (02a5ebc, 3b76f51) verified in jj log.

---
*Phase: 06-data-foundation*
*Completed: 2026-02-14*
