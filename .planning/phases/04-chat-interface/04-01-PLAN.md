---
phase: 04-chat-interface
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - web_frontend/src/components/module/NarrativeChatSection.tsx
autonomous: true

must_haves:
  truths:
    - "Chat container fills available viewport height on mobile without content hiding behind iOS Safari chrome"
    - "Chat input remains visible above keyboard when user focuses textarea on iOS Safari"
    - "Chat messages have comfortable vertical spacing between bubbles for mobile readability"
  artifacts:
    - path: "web_frontend/src/components/module/NarrativeChatSection.tsx"
      provides: "Mobile-optimized chat layout with dvh and keyboard handling"
      contains: "85dvh"
  key_links:
    - from: "textarea onFocus"
      to: "scrollIntoView"
      via: "setTimeout callback"
      pattern: "scrollIntoView.*smooth"
---

<objective>
Adapt NarrativeChatSection container height and keyboard handling for mobile devices.

Purpose: Students using iOS Safari can type messages without the input hiding behind the keyboard, and the chat fills available viewport height correctly.
Output: Chat component with dvh units and scrollIntoView keyboard handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-chat-interface/04-CONTEXT.md
@.planning/phases/04-chat-interface/04-RESEARCH.md
@web_frontend/src/components/module/NarrativeChatSection.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate chat container height from vh to dvh</name>
  <files>web_frontend/src/components/module/NarrativeChatSection.tsx</files>
  <action>
Replace the inline style `height: "85vh"` with `height: "85dvh"` and `maxHeight: "85vh"` with `maxHeight: "85dvh"` in the container div (lines 441-445).

The container currently uses:
```typescript
style={
  hasInteracted
    ? { height: "85vh", overflowAnchor: "none" }
    : { maxHeight: "85vh", minHeight: "180px", overflowAnchor: "none" }
}
```

Change to use dvh units for iOS Safari address bar compatibility:
```typescript
style={
  hasInteracted
    ? { height: "85dvh", overflowAnchor: "none" }
    : { maxHeight: "85dvh", minHeight: "180px", overflowAnchor: "none" }
}
```

This follows the pattern established in Phase 1 (01-02-SUMMARY.md) where all vh units were migrated to dvh.
  </action>
  <verify>
Run `grep -n "85vh" web_frontend/src/components/module/NarrativeChatSection.tsx` - should return no results.
Run `grep -n "85dvh" web_frontend/src/components/module/NarrativeChatSection.tsx` - should return 2 matches.
  </verify>
  <done>Chat container uses dvh units for iOS Safari viewport compatibility.</done>
</task>

<task type="auto">
  <name>Task 2: Add scrollIntoView on input focus for keyboard handling</name>
  <files>web_frontend/src/components/module/NarrativeChatSection.tsx</files>
  <action>
Add an onFocus handler to the textarea that scrolls the input into view when the mobile keyboard opens.

Per RESEARCH.md, iOS Safari pushes the viewport up when keyboard opens rather than resizing it. The scrollIntoView approach works with this native behavior.

Add this onFocus handler to the textarea (around line 663):
```typescript
<textarea
  ref={textareaRef}
  value={input}
  onChange={(e) => setInput(e.target.value)}
  onKeyDown={handleKeyDown}
  onFocus={() => {
    // Delay to let iOS keyboard animation start
    setTimeout(() => {
      textareaRef.current?.scrollIntoView({
        behavior: 'smooth',
        block: 'nearest'
      });
    }, 100);
  }}
  placeholder={...}
  // rest of props
/>
```

This ensures the input stays visible above the keyboard on iOS Safari. The 100ms delay allows the keyboard animation to begin before scrolling.

Do NOT use position:fixed for the input bar - that approach breaks on iOS Safari.
  </action>
  <verify>
Grep for scrollIntoView in the file: `grep -n "scrollIntoView" web_frontend/src/components/module/NarrativeChatSection.tsx` - should show the new onFocus handler (in addition to existing usage in useEffect).
  </verify>
  <done>Textarea scrolls into view on focus, keeping input visible above iOS Safari keyboard.</done>
</task>

<task type="auto">
  <name>Task 3: Increase message bubble spacing for mobile readability</name>
  <files>web_frontend/src/components/module/NarrativeChatSection.tsx</files>
  <action>
Increase vertical spacing between chat message bubbles for better mobile readability.

Current spacing uses `space-y-3` (0.75rem = 12px) on message containers.

Update to `space-y-4` (1rem = 16px) for more comfortable mobile reading:

1. Line 458: Change `<div className="space-y-3 pb-3">` to `<div className="space-y-4 pb-4">`
2. Line 504: Change `<div className="space-y-3">` to `<div className="space-y-4">`

Also increase message bubble padding from `p-3` (12px) to `p-4` (16px) on mobile for better touch ergonomics. Use responsive: keep desktop at p-3, mobile gets p-4.

Update message bubble classes:
- Line 470: `p-3 rounded-lg` -> `p-3 sm:p-3 rounded-lg` (keep p-3 for now, responsive adjustment comes in Plan 2 if needed)
- Actually, simpler: just change `p-3` to `p-4` consistently for all message bubbles (lines 470, 520, 542, 543, 572, 581)

Focus on space-y-4 for now - that's the primary readability improvement. Padding adjustment is optional.
  </action>
  <verify>
Grep for space-y-4: `grep -n "space-y-4" web_frontend/src/components/module/NarrativeChatSection.tsx` - should show 2 matches.
Run `npm run build` in web_frontend to verify no TypeScript errors.
  </verify>
  <done>Message bubbles have increased spacing (space-y-4) for comfortable mobile reading.</done>
</task>

</tasks>

<verification>
After all tasks:
1. `npm run lint` passes in web_frontend
2. `npm run build` passes in web_frontend
3. No vh units remain in NarrativeChatSection (only dvh)
4. scrollIntoView handler exists on textarea onFocus
5. space-y-4 spacing on message containers
</verification>

<success_criteria>
- Chat container uses 85dvh units (CHAT-01)
- Textarea has onFocus scrollIntoView handler (CHAT-02)
- Message spacing improved to space-y-4 (TYPE-03 partial)
- Build and lint pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-chat-interface/04-01-SUMMARY.md`
</output>
