---
phase: 11-answer-feedback-chat
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - content_processor/src/content-schema.ts
  - content_processor/src/index.ts
  - content_processor/src/parser/lens.ts
  - content_processor/src/flattener/index.ts
  - web_frontend/src/types/module.ts
autonomous: true

must_haves:
  truths:
    - "Content authors can add feedback:: true to a question segment and it flows through to the frontend"
  artifacts:
    - path: "content_processor/src/content-schema.ts"
      provides: "feedback field in question segment schema"
      contains: "feedback"
    - path: "content_processor/src/parser/lens.ts"
      provides: "feedback field parsing in question segment conversion"
      contains: "feedback"
    - path: "content_processor/src/flattener/index.ts"
      provides: "feedback field pass-through in flattener"
      contains: "feedback"
    - path: "content_processor/src/index.ts"
      provides: "feedback field in QuestionSegment interface"
      contains: "feedback"
    - path: "web_frontend/src/types/module.ts"
      provides: "feedback field in frontend QuestionSegment type"
      contains: "feedback"
  key_links:
    - from: "content_processor/src/parser/lens.ts"
      to: "content_processor/src/flattener/index.ts"
      via: "feedback field parsed then passed through"
      pattern: "feedback"
---

<objective>
Add the `feedback` boolean field through the content processor pipeline so content authors can flag questions for AI feedback.

Purpose: Enables the per-question feature flag that controls whether feedback chat appears after answer submission (FB-01).
Output: `feedback:: true` in question segment markdown is parsed, flattened, and available as `segment.feedback` in the frontend QuestionSegment type.
</objective>

<execution_context>
@/home/penguin/.claude/get-shit-done/workflows/execute-plan.md
@/home/penguin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-answer-feedback-chat/11-RESEARCH.md
@content_processor/src/content-schema.ts
@content_processor/src/index.ts
@content_processor/src/parser/lens.ts
@content_processor/src/flattener/index.ts
@web_frontend/src/types/module.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add feedback field through content processor pipeline and frontend types</name>
  <files>
    content_processor/src/content-schema.ts
    content_processor/src/parser/lens.ts
    content_processor/src/flattener/index.ts
    content_processor/src/index.ts
    web_frontend/src/types/module.ts
  </files>
  <action>
Add `feedback` as an optional boolean field to the question segment across all 5 files:

1. **content-schema.ts** -- In `SEGMENT_SCHEMAS['question']`, add `'feedback'` to the `optionalFields` array (after `'optional'`) and add `'feedback'` to the `booleanFields` array. The call becomes:
   ```
   segmentSchema(
     ['user-instruction'],
     ['assessment-prompt', 'max-time', 'max-chars', 'enforce-voice', 'optional', 'feedback'],
     ['enforce-voice', 'optional', 'feedback'],
   )
   ```

2. **parser/lens.ts** -- Add `feedback?: boolean` to the `ParsedQuestionSegment` interface (after `optional?: boolean`). In the `case 'question':` block of `convertSegment` (~line 394), add:
   ```typescript
   feedback: raw.fields['feedback']?.toLowerCase() === 'true' ? true : undefined,
   ```
   Add this after the `optional` line.

3. **flattener/index.ts** -- In the `case 'question':` block of `convertSegment` (~line 1057), add after the `optional` line:
   ```typescript
   if (parsedSegment.feedback) segment.feedback = true;
   ```

4. **index.ts** -- Add `feedback?: boolean` to the `QuestionSegment` interface (after `optional?: boolean`).

5. **web_frontend/src/types/module.ts** -- Add `feedback?: boolean` to the `QuestionSegment` type (after `optional?: boolean`).
  </action>
  <verify>
Run `cd content_processor && npx tsc --noEmit` to confirm no TypeScript errors.
Run `cd web_frontend && npm run build` to confirm frontend compiles with new type.
  </verify>
  <done>
`feedback:: true` in question segment markdown is parsed, flattened, and available as `segment.feedback` in frontend QuestionSegment type. TypeScript compiles clean in both content_processor and web_frontend.
  </done>
</task>

</tasks>

<verification>
1. Content processor: `feedback:: true` in question markdown is parsed and appears in flattened output
2. Frontend types: `QuestionSegment.feedback` is `boolean | undefined`
3. No regressions: `npx tsc --noEmit` in content_processor, `npm run build` in web_frontend pass
</verification>

<success_criteria>
- feedback field flows from content-schema.ts through parser, flattener, index.ts, and frontend types
- All type checks pass clean
</success_criteria>

<output>
After completion, create `.planning/phases/11-answer-feedback-chat/11-01-SUMMARY.md`
</output>
